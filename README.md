# grunt-rails-asset-digest

[![Build Status](https://travis-ci.org/davemo/grunt-rails-asset-digest.png?branch=master)](https://travis-ci.org/davemo/grunt-rails-asset-digest)


> Generates fingerprinted assets and appends entries to a rails manifest

## Intended Use

This plugin is intended to be used by those who are integrating a grunt workflow alongside of the Rails Asset Pipeline. As such, this task expects to be run _after_ the rails asset pipeline has generated an asset manifest.yml file.

This approach works well in that it only manages fingerprinting and manifest modification for the files that are explicitly managed in the `files` property and it guarantees that existing entries generated by Rails will not be touched.

## Why would I use this?

If you are using something like [Lineman](http://www.linemanjs.com) or Grunt and want more control over an advanced front-end workflow to be used alongside a legacy Rails application. A great candidate for this task is to utilize it during construction of a rich-client JavaScript application that lives inside a Rails application. You can let the Rails asset pipeline manage legacy files, and let your Grunt workflow manage your rich-client files.

Ideally this task should not exist; the best way to build a rich-client JavaScript application is to decouple it completely from the serverside. However this is a reasonable _first step_ in refactoring to extract assets from the clutches of the rails asset pipeline and still be able to hook into most rails app deploy processes.

## How would I integrate this task?

Adjust your rails deployment lifecycle to run this task prior to deploying/uploading assets (whether to a CDN, or just in `public/assets` which is where this task will dump fingerprinted assets by default). Here's an example configuration in a [Capistrano](https://github.com/capistrano/capistrano) deploy setup that uses [Lineman](http://www.linemanjs.com) to manage the lifecycle of a rich-client application that still lives within a rails source tree. (The same techniques will work with vanilla Grunt, you'll just have to manage the task aliasing yourself)

```coffeescript
# linemans config/application.coffee
appTasks:
  common: [
    "sass"
    "coffee"
    "concat"
  ]
  dist: [
    "uglify"
    "rails_asset_digest"
    "clean"
  ]
```

```ruby
# config/deploy.rb

after 'assets:compress', 'assets:compile_with_lineman', 'assets:upload'

task :compile_with_lineman
  logger.important "Compiling other assets with Lineman"
  run "lineman build" # run grunt tasks in common and dist phases
end
```

**Note:** this is a _very_ narrowly focused task, and you might not get much use out of it :)

## Getting Started
This plugin requires Grunt `~0.4.1`

If you haven't used [Grunt](http://gruntjs.com/) before, be sure to check out the [Getting Started](http://gruntjs.com/getting-started) guide, as it explains how to create a [Gruntfile](http://gruntjs.com/sample-gruntfile) as well as install and use Grunt plugins. Once you're familiar with that process, you may install this plugin with this command:

```shell
npm install grunt-rails-asset-digest --save-dev
```

Once the plugin has been installed, it may be enabled inside your Gruntfile with this line of JavaScript:

```js
grunt.loadNpmTasks('grunt-rails-asset-digest');
```

## The "rails_asset_digest" task

### Overview
In your project's Gruntfile, add a section named `rails_asset_digest` to the data object passed into `grunt.initConfig()`.

```js
grunt.initConfig({
  rails_asset_digest: {
    options: {
      algorithm: 'md5',          // default fingerprinting algorithm to use
      assetPath: 'public/assets' // default location where manifest.yml lives
    },
    your_target: {
      files: {
        // dest : src
        "public/assets/javascript-file.js"    : "input/path/to/javascript-file.js",
        "public/assets/sourcemap-file.js.map" : "input/path/to/sourcemap-file.js.map",
        "public/assets/style.css"             : "input/path/to/style.css"
      }
    },
  },
})
```

### Sample Output

Given the configuration in the Overview section above, you can expect `grunt rails_asset_digest` to output the following to `public/assets`

```shell
ls -la public/assets
manifest.yml
javascript-file-a5a14aa0f19b8fe989f3b79fc72b9b36.js
sourcemap-file-365b31e16181703b506e90b57f95b568.js.map
style-1fd9137f040f2440d26da164c65e7f66.css
```

And the associaated fingerprinted entries in manifest.yml like so:

```yaml
---
javascript-file.js: javascript-file-a5a14aa0f19b8fe989f3b79fc72b9b36.js
sourcemap-file.js.map: sourcemap-file-365b31e16181703b506e90b57f95b568.js.map
style.css: style-1fd9137f040f2440d26da164c65e7f66.css
```

### Options

#### options.algorithm
Type: `String`
Default value: `md5`

The digest algorithm used to fingerprint the assets.

#### options.assetPath
Type: `String`
Default value: `public/assets`

The location of the rails asset path

## Contributing
In lieu of a formal styleguide, take care to maintain the existing coding style. Add unit tests for any new or changed functionality. Lint and test your code using [Grunt](http://gruntjs.com/).

## License

MIT
